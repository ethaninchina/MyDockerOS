#生成新镜像,基于私有仓库 daocloud.io/library/centos:6.8
FROM daocloud.io/library/centos:6.8
#作者信息
MAINTAINER wyz "wyz@test.com"
#安装各种服务，修改时区
RUN yes|cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
#创建文件夹
RUN mkdir -p /data/docker/logs /data/docker/website /opt/backup
#创建使用用户 apache
RUN useradd -M -s /sbin/nologin apache


#下载安装源
RUN rpm -Uvh http://ftp.iij.ad.jp/pub/linux/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm \
&& rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm \
&& yum update -y

#安装其他相关依赖
RUN yum install -y vim git ntp make openssl openssl-devel pcre pcre-devel libpng libpng-devel libjpeg libjpeg-devel freetype freetype-devel gd gd-devel zlib zlib-devel gcc gcc-c++ libXpm libXpm-devel ncurses ncurses-devel libmcrypt libmcrypt-devel libxml2 libxml2-devel imake autoconf automake screen sysstat compat-libstdc++-33 curl curl-devel readline-devel libxslt-devel net-snmp-devel readline-devel aspell-devel unixODBC-devel libicu-devel libc-client-devel  freetype-devel libXpm-devel libpng-devel libvpx-devel enchant-devel libcurl-devel libssl-dev bzip2-devel db4-devel gmp-devel openldap-devel unixODBC-devel net-snmp-devel aspell-devel libxml2-devel libicu-devel libmcrypt-devel libtidy-devel

#安装php-fpm和PHP插件
RUN yum install -y --enablerepo=remi --enablerepo=remi-php56 php php-opcache php-devel php-mbstring php-mcrypt php-mysqlnd php-phpunit-PHPUnit php-pecl-xdebug php-pecl-xhprof php-fpm php-redis php-pecl-mongo php-gd php-gmp php-imap php-tidy php-ldap

#安装supervisord
RUN yum -y install python-pip \
&& pip install supervisor \
&& pip install setuptools --upgrade

#关闭php的 deamon模式
RUN sed -i 's/daemonize = yes/daemonize = no/g' /etc/php-fpm.conf

RUN echo [supervisord] > /etc/supervisord.conf \
    && echo nodaemon=true >> /etc/supervisord.conf \
    \
    && echo [program:php-fpm] >> /etc/supervisord.conf \
    && echo command=/usr/sbin/php-fpm -c /etc/php.ini -y /etc/php-fpm.conf >> /etc/supervisord.conf

#开放端口
EXPOSE 9000

#启动后执行脚本
CMD ["/usr/bin/supervisord"]
